#!/bin/bash

set -e

function cleanup() {
  exit_code=$?
  set +e

  echo "copying coverage reports..."
  docker cp $(docker-compose ps -q coverage):/usr/src/app/coverage .

  echo "cleaning up..."
  docker-compose stop test
  docker-compose rm -f test
  docker rmi -f $(docker images -qf "dangling=true") &>/dev/null

  exit $exit_code
}

trap cleanup INT TERM EXIT

export COMPOSE_FILE=./docker-compose.test.yml

echo "pull image..."
docker-compose pull

echo "building services..."
docker-compose build

echo "running tests..."
docker-compose run -u "root" test bash -c "yarn test"

if [[ $TRAVIS_BRANCH == 'master' && -z "$TRAVIS_PULL_REQUEST" ]]; then
  commit_msg=$(git log -1 --pretty=format:%s)

  if [[ "$commit_msg" =~ "^chore(release): " ]]; then
    echo "Running the release..."
    docker-compose run -u "root" test bash -c "yarn release -t latest"
  fi
fi
