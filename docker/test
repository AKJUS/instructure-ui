#!/bin/bash

set -e

function cleanup() {
  exit_code=$?
  set +e

  echo "Lerna debug log..."
  cat lerna-debug.log

  echo "Copying coverage reports..."
  docker cp $(docker-compose ps -q coverage):/usr/src/app/coverage .

  echo "Cleaning up..."
  docker-compose stop test
  docker-compose rm -f test
  docker rmi -f $(docker images -qf "dangling=true") &>/dev/null

  exit $exit_code
}

trap cleanup INT TERM EXIT

export COMPOSE_FILE=./docker-compose.test.yml

echo "Pulling image..."
docker-compose pull

echo "Building services..."
docker-compose build

echo "Running ci script..."
docker-compose run -u "root" test bash -c "./scripts/ci"
